name: Deploy AWS - DEV OPS

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests
        run: mvn test

      - name: Build java
        run: mvn clean install -DskipTests

      - name: Login Docker Hub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build docker image
        run: docker build -t didopereira/meu-transporte-escolar-dev-ops:latest .

      - name: Push docker image
        run: docker push didopereira/meu-transporte-escolar-dev-ops:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ”§ Creating docker network..."
            sudo docker network create app-network || true

            echo "ðŸ“¦ Pulling latest docker image..."
            sudo docker pull didopereira/meu-transporte-escolar-dev-ops:latest

            echo "ðŸ§¹ Removing old app container..."
            sudo docker rm -f meu-transporte-escolar-dev-ops || true

            echo "ðŸš€ Starting app container..."
            sudo docker run -d \
              --network app-network \
              -p 8080:8080 \
              -e DATABASE_HOST="${{secrets.DATABASE_HOST}}" \
              -e DATABASE_PORT="${{secrets.DATABASE_PORT}}" \
              -e DATABASE_NAME="${{secrets.DATABASE_NAME}}" \
              -e DATABASE_USERNAME="${{secrets.DATABASE_USERNAME}}" \
              -e DATABASE_PASSWORD="${{secrets.DATABASE_PASSWORD}}" \
              -e JWT_SECRET="${{secrets.JWT_SECRET}}" \
              --name meu-transporte-escolar-dev-ops \
              didopereira/meu-transporte-escolar-dev-ops:latest

            echo "âœ… Deploy completed!"
